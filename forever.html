<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forever In Sound</title>

  <!-- GLOBAL NAV STYLES -->
  <link rel="stylesheet" href="../styles/global.css">
  <script src="../components/nav.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Helvetica, Arial, sans-serif;
      background: white;
      color: black;
      overflow-x: hidden;
      width: 100%;
    }

    html {
      scroll-behavior: smooth;
    }

    /* Main content area */
    .content-container {
      width: calc(100% - 150px);
      margin: 0 auto;
      padding: 40px 40px 40px 40px;
      box-sizing: border-box;
      max-width: 900px;
    }

    h1 {
      font-size: 80px;
      font-weight: bold;
      margin-bottom: 40px;
    }

    .section {
      padding: 60px 0;
      min-height: 50vh;
    }

    .section-title {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .section p {
      margin-bottom: 1em;
      line-height: 1.6;
    }

    /* Grid Navigation - Desktop only */
    .grid-nav {
      position: fixed;
      right: 0;
      top: 60px;
      width: 150px;
      height: calc(100vh - 60px);
      background: white;
      padding: 20px 30px 20px 10px;
      overflow-y: auto;
      z-index: 500;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(5, 25px);
      gap: 2px;
      margin-top: 20px;
    }

    .grid-square {
      width: 25px;
      height: 25px;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      color: #ddd;
    }

    .grid-square.filled {
      background: black;
      border-color: black;
      color: #444;
    }

    .grid-square.active {
      transform: scale(1.3);
      z-index: 10;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
    }

    .grid-square:hover {
      transform: scale(1.2);
      z-index: 9;
    }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: black;
      color: white;
      padding: 8px 12px;
      font-size: 11px;
      white-space: nowrap;
      pointer-events: none;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.2s ease;
      max-width: 200px;
    }

    .tooltip.visible {
      opacity: 1;
    }

    /* Media - Images, Videos, Audio */
    .photo {
      max-width: 600px;
      margin: 2em 0;
      display: block;
      max-width: 100%;
    }

    .video-row-2up {
      display: flex;
      gap: 10px;
      margin: 2em 0;
      flex-wrap: wrap;
    }

    .youtube-placeholder {
      position: relative;
      flex: 1;
      min-width: 300px;
      max-width: 400px;
      background: black;
      cursor: pointer;
      overflow: hidden;
      aspect-ratio: 16/9;
      max-width: 100%;
    }

    .youtube-placeholder img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
    }

    .play-button {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 68px;
      height: 48px;
      background: url('https://img.icons8.com/ios-filled/100/ffffff/play-button-circled.png') no-repeat center;
      background-size: contain;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .audio-track {
      margin: 2em 0;
    }

    .track-top-line {
      font-style: italic;
      margin-bottom: 0.5em;
    }

    .track-instruments {
      font-size: 0.65rem;
      font-style: italic;
      color: #444;
      margin-bottom: 0.5em;
    }

    .custom-audio-wrapper {
      border: 1px solid black;
      padding: 0;
      display: block;
      max-width: 320px;
      width: 100%;
    }

    .custom-audio-wrapper audio {
      width: 100%;
      height: 36px;
      display: block;
    }

    iframe {
      margin: 2em 0;
    }

    /* Mobile: hide grid, full width content */
    @media (max-width: 768px) {
      .grid-nav {
        display: none;
      }

      .content-container {
        width: 100%;
        padding: 80px 20px 20px 20px;
        max-width: 100%;
      }

      h1 {
        font-size: 48px;
      }

      .video-row-2up {
        flex-direction: column;
      }

      .youtube-placeholder {
        min-width: 100%;
      }
    }

    /* Tablet: adjust content width to avoid grid overlap */
    @media (min-width: 769px) and (max-width: 1200px) {
      .content-container {
        width: calc(100% - 200px);
        max-width: 600px;
      }
    }
  </style>
</head>

<body>

  <script>
    window.toggleMobileMenu = function () {
      const menu = document.getElementById('mobileMenu');
      if (menu) {
        menu.classList.toggle('visible');
      }
    };

    fetch('../components/nav.html')
      .then(res => res.text())
      .then(html => {
        document.body.insertAdjacentHTML('afterbegin', html);
      });
  </script>

  <!-- Grid Navigation -->
  <div class="grid-nav" id="gridNav">
    <div class="grid-container" id="gridContainer"></div>
  </div>

  <!-- Tooltip -->
  <div class="tooltip" id="tooltip"></div>

  <!-- Main Content -->
  <div class="content-container">
    <h1>FOREVER IN SOUND</h1>
    <div id="sectionsContainer"></div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let sections = [];
    let players = [];

    // Load content from JSON
    fetch('../data/forever.json')
      .then(res => res.json())
      .then(data => {
        sections = data;
        renderSections();

        // Only render grid on desktop
        if (window.innerWidth > 768) {
          renderGrid();
          setupScrollObserver();
        } else {
          // Remove grid nav from DOM on mobile
          document.getElementById('gridNav')?.remove();
        }
      });

    function renderSections() {
      const container = document.getElementById('sectionsContainer');

      sections.forEach(section => {
        const div = document.createElement('div');
        div.className = 'section';
        div.id = section.id;

        let html = `<h2 class="section-title">${section.title}</h2>`;
        html += section.text.split('\n').map(p => `<p>${p}</p>`).join('');

        // YouTube videos
        if (section.media?.youtube) {
          const vids = section.media.youtube.map(id => `
            <div class="youtube-placeholder" data-id="${id}">
              <img src="https://img.youtube.com/vi/${id}/hqdefault.jpg" alt="YouTube thumbnail">
              <div class="play-button"></div>
            </div>
          `).join('');
          html += `<div class="video-row-2up">${vids}</div>`;
        }

        // Bandcamp embed
        if (section.media?.bandcamp_embed) {
          html += section.media.bandcamp_embed;
        }

        // Audio
        if (section.media?.audio) {
          html += `
            <div class="audio-track">
              <div class="track-top-line"><i>${section.media.audioTitle || 'Audio'}</i></div>
              ${section.media.instruments ? `<div class="track-instruments">${section.media.instruments}</div>` : ''}
              <div class="custom-audio-wrapper">
                <audio controls preload="none" controlsList="nodownload">
                  <source src="${section.media.audio}" type="audio/mpeg">
                </audio>
              </div>
            </div>
          `;
        }

        // Image
        if (section.media?.image) {
          html += `<img class="photo" src="${section.media.image}" alt="${section.title}">`;
        }

        div.innerHTML = html;
        container.appendChild(div);

        // Setup YouTube lazy loading
        div.querySelectorAll('.youtube-placeholder').forEach(placeholder => {
          placeholder.addEventListener('click', () => loadYouTube(placeholder));
        });
      });
    }

    function renderGrid() {
      const grid = document.getElementById('gridContainer');
      const totalSquares = Math.ceil((window.innerHeight - 60) / 27) * 5; // Calculate squares to fill height

      for (let i = 0; i < totalSquares; i++) {
        const square = document.createElement('div');
        square.className = 'grid-square';

        if (i < sections.length) {
          square.classList.add('filled');
          square.dataset.index = i;
          square.dataset.id = sections[i].id;
          square.dataset.title = sections[i].title;
          square.textContent = i + 1;

          // Click to navigate
          square.addEventListener('click', () => {
            document.getElementById(sections[i].id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });

          // Hover tooltip
          square.addEventListener('mouseenter', (e) => showTooltip(e, sections[i].title));
          square.addEventListener('mouseleave', hideTooltip);
        }

        grid.appendChild(square);
      }
    }

    function showTooltip(e, title) {
      const tooltip = document.getElementById('tooltip');
      const rect = e.target.getBoundingClientRect();
      tooltip.textContent = title;
      tooltip.style.right = (window.innerWidth - rect.left + 10) + 'px';
      tooltip.style.top = rect.top + 'px';
      tooltip.classList.add('visible');
    }

    function hideTooltip() {
      document.getElementById('tooltip').classList.remove('visible');
    }

    function setupScrollObserver() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            // Remove active from all squares
            document.querySelectorAll('.grid-square.active').forEach(s => s.classList.remove('active'));

            // Add active to current square
            const square = document.querySelector(`.grid-square[data-id="${entry.target.id}"]`);
            if (square) square.classList.add('active');
          }
        });
      }, {
        rootMargin: '-40% 0px -40% 0px',
        threshold: 0.1
      });

      sections.forEach(section => {
        const el = document.getElementById(section.id);
        if (el) observer.observe(el);
      });
    }

    function loadYouTube(placeholder) {
      const id = placeholder.dataset.id;
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${id}?enablejsapi=1`;
      iframe.frameBorder = '0';
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;
      iframe.width = '100%';
      iframe.style.height = '100%';
      placeholder.innerHTML = '';
      placeholder.appendChild(iframe);

      setTimeout(() => {
        const player = new YT.Player(iframe, {
          events: { 'onStateChange': onPlayerStateChange }
        });
        players.push(player);
      }, 100);
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING) {
        players.forEach(player => {
          if (player !== event.target && player.pauseVideo) {
            player.pauseVideo();
          }
        });
      }
    }

    function onYouTubeIframeAPIReady() {
      // API ready callback
    }

  </script>

</body>

</html>